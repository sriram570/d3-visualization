<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>CSE 564 Lab 1</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='//fonts.googleapis.com/css?family=Fredericka the Great' rel='stylesheet'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
</head>

<style>
	.axis path,
	.axis line {
		fill: none;
		stroke: black;
		shape-rendering: crispEdges;
	}
	.axis text {
		font-family: sans-serif;
		font-size: 11px;
	}
	body {
		font-family: 'Fredericka the Great';
		font-size: 22px;
		align: center;
	}
	.bar {
		fill: #ff3333;
	}
	.bar:hover {
		fill: #660000;
	}
	.d3-tip {
		font-size: 15px;
		line-height: 1;
		font-weight: bold;
		padding: 12px;
		background: rgba(0, 0, 0, 0.8);
		color: #fff;
		border-radius: 2px;
	}
	/* Creates a small triangle extender for the tooltip */
	.d3-tip:after {
		box-sizing: border-box;
		display: inline;
		font-size: 10px;
		width: 100%;
		line-height: 1;
		color: rgba(0, 0, 0, 0.8);
		content: "\25BC";
		position: absolute;
		text-align: center;
	}
	/* Style northward tooltips differently */
	.d3-tip.n:after {
		margin: -1px 0 0 0;
		top: 100%;
		left: 0;
	}
	.bar rect {
		shape-rendering: crispEdges;
	}
	.bar text {
		fill: #999999;
	}
	.col-centered{
		float: none;
		margin: 0 auto;
	}
	.arc text {
		font: 10px sans-serif;
		text-anchor: middle;
	}
	.arc path {
		stroke: #fff;
	}
</style>

<body>

	<section class="jumbotron text-center">
		<div class="container">
			<h2 id="navigator">Air Pollution Data</h2>
			<h3>
			<div class="row">
				<div class="col-lg-2 col-centered">
					<div class="form-group">
						<select id="my-dropdown" name="my-dropdown" class="form-control" onchange="init_histogram(this.value)">
						</select>
					</div>
				</div>
			</div>
			</h3>
		</div>

	</section>

	<script type="text/javascript">

	var dataset;
	var col_names, no_bins = 10;
	var data, x, histogram, pie;
	var pady = 50, tip;
	var padx = 50;
	var margin = {top: 20, right: 30, bottom: 30, left: 30};
	var width = 900 - margin.left - margin.right;
	var height = 550 - margin.top - margin.bottom;
	var color = "steelblue";
	var radius = Math.min(width, height) / 2;

	function draw_histogram() {
		var y_max = d3.max(data.map(function(d){return d.length}));
		var y_min = d3.min(data.map(function(d){return d.length}));

		var xScale = d3.scale.linear()
			.domain([0,d3.max(data.map(function(d) {return d.x}))])
			.range([padx/2,width-(padx/2)]);

		var yScale = d3.scale.linear()
			.domain([0,d3.max(data.map(function(d) {return d.length}))])
			.range([height-pady*2,0]);

		var heightScale = d3.scale.linear()
			.domain([0,d3.max(data.map(function(d) {return d.length}))])
			.range([0,height-pady*2]);

		var xAxis = d3.svg.axis()
			.scale(xScale)
			.orient("bottom")
			.ticks(no_bins);

		var colorScale = d3.scale.category20c();

		/*var colorScale = d3.scale.linear()
			.domain([y_min, y_max])
			.range([d3.rgb(color).brighter(), d3.rgb(color).darker()]);
		*/
		var xPos = d3.scale.linear()
			.domain([0,d3.max(data.map(function(d) {return d.x}))])
			.range([padx/2,width-padx]);

		tip = d3.tip()
			.attr('class', 'd3-tip')
		 	.offset([-10, 0])
		 	.html(function(d) {
		 	return "<strong>Frequency:</strong> <span style='color:white'>" + d.length + "</span>";
		  })
		svg.call(tip);

		var bar = svg.selectAll("rect")
			.data(histogram)
			.enter()
			.append("rect")
			.on('mouseover', function(d) {
				d3.select(this)
				.attr("height", function(d) {return heightScale(d.y) + 15})
				.attr("width", 80)
				.attr("transform", "translate(0,-15)");
			tip.show(d);
		})
		.on('mouseout', function(d, i) {
			d3.select(this)
				.attr("fill", function(d, i) {return colorScale(d.x)})
				.attr("height", function(d) {return heightScale(d.y)})
				.attr("width", 65)
				.attr("transform", "translate(7.5, 0)");
			tip.hide(d);
		})
		.attr("class", "bar")
		.attr("fill", function(d,i) { return colorScale(d.x) })
		.attr("x", function(d) { return xPos(d.x)})
		.attr("height", 0)
		.attr("y", function(d,i) { return height-pady })
		.attr("width", 65)
		.attr("transform", "translate(5,0)")
		.transition()
		.duration(800)
		.delay(function (d,i) { return i*50 })
			.attr("y", function(d) { return yScale(d.y) +pady})
			.attr("height", function(d) { return heightScale(d.y) });
		
		svg.append("g")
			.attr("class","axis")
			.attr("transform", "translate(35, "+ (height - pady + 15) +")")
			.call(xAxis);

	}


	function init_histogram(column) {
		svg.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		var index = col_names.indexOf(column);
		var col_data = dataset.map(function(d) {return parseInt(d[column]);});
		histogram = d3.layout.histogram()
			.bins(no_bins)
			(col_data);
		data = histogram;
		svg.selectAll("*").remove();
		draw_histogram();
	}


	var svg = d3.select("div")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


	function process_data(arr) {
		var max = Math.max.apply(null, arr);
		var min = Math.min.apply(null, arr);
		var dict = {};
		var start_of_range = {};
		var end_of_range = {};
		var method = {};
		var range = {};
		var n = no_bins;
		var count = {};
		var len = Object.keys(start_of_range).length;
		var length_of_range = (max - min + 1) / n;

		for (var i = 1; i <= n; i++) {
			count[i] = 0;
		}

		for (var i = 1; i <= n; i++) {
			start_of_range[i] = Math.ceil(length_of_range * (i-1) + min);
			if ( i != 1 && start_of_range[i] == end_of_range[i-1])
				start_of_range[i] += 1;
			if ( i != 1 && start_of_range[i] == end_of_range[i-1] - 1)
				start_of_range[i] += 2;
			if ( i != 1 && start_of_range[i] == end_of_range[i-1] - 2)
				start_of_range[i] += 3;
			end_of_range[i] = Math.ceil(start_of_range[i] + length_of_range - 1); 
		}

		for (var i = 1; i < arr.length; i++) {
			method[arr[i]] = Math.floor((arr[i] - min) / length_of_range + 1);
			count[method[arr[i]]] += 1;
		}

		var array = [];
		for (var i = 1; i <= n; i++) {
			array.push({
				key: start_of_range[i].toString() + '-' + end_of_range[i].toString(),
				value: count[i]
			});
		}

		return array;
	}


	function draw_pie(data) {

		var color = d3.scale.category20c();  

		var arc = d3.svg.arc()
			.outerRadius(radius - 10)
			.innerRadius(25);

		pie = d3.layout.pie()
			.sort(null)
			.value(function(d) { return d.value; });

		tip = d3.tip()
			.attr('class', 'd3-tip')
		 	.offset([-10, 0])
		 	.html(function(d) {
		 	return "<span style='color:white'>" + d.data.key + "</span>";
		  })
		svg.call(tip);

		var path = svg.selectAll("path")
			.data(pie(data))
			.enter()
			.append("path")
			.on("mouseover", function (d) {
				d3.select(this)
					.attr("width", d3.event.pageX)
					.attr("height", d3.event.pageY)
				tip.show(d);
			})			
			.on("mouseout", function (d) {
				tip.hide(d);
			})
			.attr("fill", function(d, i) { return color(i); })
			.transition()
		    .delay(function(d, i) {
		    	return i * 800;
			})
			.attrTween('d', function(d) {
				var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
				return function(t) {
					d.endAngle = i(t);
					return arc(d);
   				}
   			});


		svg.selectAll("path").append("text")
			.attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
			.attr("dy", ".35em")
			.text(function(d) { return d.data.key; });

		function type(d) {
			d.value = +d.value;
			return d;
		}
	}


	function init_pie(column) {
		svg.attr("transform", "translate(" + (width / 2 + margin.left) + "," + (height / 2 + margin.top) + ")");
		var index = col_names.indexOf(column);
		var col_data = dataset.map(function(d) {return parseInt(d[column]);});
		var processed_data = process_data(col_data);
		svg.selectAll("*").remove();
		draw_pie(processed_data);
	}


	d3.csv("winter.csv", function(error, data) {
		var isPie = false;
		dataset = data;
		col_names = Object.keys(d3.values(data)[0]);
		d3.select("select").selectAll("option")
			.data(col_names)
			.enter()
			.append("option")
			.attr("value", function(d) {return d})
			.text(function(d) {return d});
		
		init_histogram(col_names[0]);

		svg.on("click", function(d, i) {
			var selected = $('#my-dropdown option:selected');
			tip.hide(d);
			if (isPie) {
				isPie = false;
				init_histogram(selected.html());
			}
			else {
				isPie = true;
				init_pie(selected.html())
			}
		});
	});

	/* Adding event listener for leftward and rightward movement detection */
	var direction = "",
	oldx = 0,
	
	mousemovemethod = function (e) {
		if (e.pageX < oldx) {
			direction = "left"
		} else if (e.pageX > oldx) {
			direction = "right"
		}

		console.log(direction);
		oldx = e.pageX;
	}
	var drag_area = document.getElementById("navigator");
	drag_area.addEventListener("click", mousemovemethod, true);
	
	</script>

</body>

</html>